<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2Ray Collector Dashboard - داشبورد مدیریتی</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stats-card {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .stats-card.success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .stats-card.warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }

        .stats-card.info {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .protocol-badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
        }

        .country-flag {
            font-size: 1.2em;
            margin-right: 0.3em;
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .loading {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .alert-custom {
            border: none;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-body text-center">
                        <h1 class="display-4 mb-3">
                            <i class="fas fa-rocket text-primary"></i>
                            V2Ray Collector Dashboard
                        </h1>
                        <p class="lead text-muted">مدیریت و نظارت بر کانفیگ‌های V2Ray</p>
                        <div class="d-flex justify-content-center gap-3">
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle"></i> سیستم فعال
                            </span>
                            <span class="badge bg-info fs-6" id="lastUpdate">
                                <i class="fas fa-clock"></i> آخرین بروزرسانی: در حال بارگذاری...
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card success fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h3 class="card-title" id="totalHealthy">-</h3>
                        <p class="card-text">کانفیگ‌های سالم</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card warning fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-3x mb-3"></i>
                        <h3 class="card-title" id="totalFailed">-</h3>
                        <p class="card-text">کانفیگ‌های ناسالم</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card info fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-globe fa-3x mb-3"></i>
                        <h3 class="card-title" id="totalSources">-</h3>
                        <p class="card-text">منابع فعال</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h3 class="card-title" id="successRate">-%</h3>
                        <p class="card-text">نرخ موفقیت</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Protocol Distribution -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie text-primary"></i>
                            توزیع پروتکل‌ها
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="protocolStats">
                            <!-- Protocol statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Country Distribution -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-flag text-primary"></i>
                            توزیع جغرافیایی
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="countryStats">
                            <!-- Country statistics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Configs Table -->
        <div class="row">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list text-primary"></i>
                            کانفیگ‌های اخیر
                        </h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="filter" id="all" autocomplete="off" checked>
                            <label class="btn btn-outline-primary btn-sm" for="all">همه</label>

                            <input type="radio" class="btn-check" name="filter" id="vmess" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="vmess">VMess</label>

                            <input type="radio" class="btn-check" name="filter" id="vless" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="vless">VLESS</label>

                            <input type="radio" class="btn-check" name="filter" id="trojan" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="trojan">Trojan</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>پروتکل</th>
                                        <th>آدرس</th>
                                        <th>پورت</th>
                                        <th>کشور</th>
                                        <th>وضعیت</th>
                                        <th>تأخیر</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="configsTable">
                                    <!-- Config data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs text-primary"></i>
                            وضعیت سیستم
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="systemStatus">
                            <!-- System status will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
        style="background: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="text-center text-white">
            <div class="spinner-border text-light mb-3" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
            <h4>در حال بارگذاری داده‌ها...</h4>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary btn-lg rounded-circle refresh-btn" onclick="loadDashboardData()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Country flags mapping
        const countryFlags = {
            'US': '🇺🇸', 'DE': '🇩🇪', 'IR': '🇮🇷', 'CA': '🇨🇦', 'NL': '🇳🇱',
            'TR': '🇹🇷', 'SE': '🇸🇪', 'IN': '🇮🇳', 'RU': '🇷🇺', 'ES': '🇪🇸',
            'NO': '🇳🇴', 'LT': '🇱🇹', 'HK': '🇭🇰', 'CN': '🇨🇳', 'CF': '🚩',
            'unknown': '❓'
        };

        // Protocol colors
        const protocolColors = {
            'vmess': 'primary',
            'vless': 'success',
            'trojan': 'warning',
            'ss': 'info',
            'ssr': 'secondary'
        };

        // Load dashboard data
        async function loadDashboardData() {
            document.querySelector('.loading').style.display = 'flex';

            try {
                // Load latest report
                const reportResponse = await fetch('latest_report.json');
                const report = await reportResponse.json();

                updateStatistics(report);
                updateProtocolStats(report);
                updateCountryStats(report);
                updateSystemStatus(report);
                updateLastUpdate(report);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('خطا در بارگذاری داده‌ها');
            }

            document.querySelector('.loading').style.display = 'none';
        }

        // Update statistics cards
        function updateStatistics(report) {
            // Fix: working_configs and failed_configs are numbers, not arrays
            const totalHealthy = report.working_configs || 0;
            const totalFailed = report.failed_configs || 0;
            const totalTested = report.total_configs_tested || 0;
            const totalSources = 28; // تعداد منابع

            // Parse success_rate if it's a string like "70.5%"
            let successRate = 0;
            if (typeof report.success_rate === 'string') {
                successRate = parseFloat(report.success_rate.replace('%', ''));
            } else {
                successRate = totalHealthy + totalFailed > 0 ?
                    Math.round((totalHealthy / (totalHealthy + totalFailed)) * 100) : 0;
            }

            document.getElementById('totalHealthy').textContent = totalHealthy.toLocaleString('fa-IR');
            document.getElementById('totalFailed').textContent = totalFailed.toLocaleString('fa-IR');
            document.getElementById('totalSources').textContent = totalSources;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Update protocol statistics
        function updateProtocolStats(report) {
            // Fix: protocols is an object with count and avg_latency
            const protocolStats = report.protocols || {};
            const totalConfigs = report.working_configs || 0;

            const protocolContainer = document.getElementById('protocolStats');
            protocolContainer.innerHTML = '';

            Object.entries(protocolStats).forEach(([protocol, data]) => {
                const count = data.count || 0;
                const avgLatency = data.avg_latency || 'N/A';
                const percentage = totalConfigs > 0 ?
                    Math.round((count / totalConfigs) * 100) : 0;

                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6 mb-3';
                col.innerHTML = `
                    <div class="text-center">
                        <div class="h4 text-${protocolColors[protocol] || 'secondary'}">${count.toLocaleString('fa-IR')}</div>
                        <div class="text-muted">${protocol.toUpperCase()}</div>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar bg-${protocolColors[protocol] || 'secondary'}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">${percentage}% • ${avgLatency}</small>
                    </div>
                `;
                protocolContainer.appendChild(col);
            });
        }

        // Update country statistics
        function updateCountryStats(report) {
            const countryContainer = document.getElementById('countryStats');
            countryContainer.innerHTML = '';

            // Show top countries with most configs
            const topCountries = [
                { code: 'US', name: 'آمریکا', flag: '🇺🇸' },
                { code: 'DE', name: 'آلمان', flag: '🇩🇪' },
                { code: 'NL', name: 'هلند', flag: '🇳🇱' },
                { code: 'CA', name: 'کانادا', flag: '🇨🇦' },
                { code: 'GB', name: 'انگلیس', flag: '🇬🇧' },
                { code: 'FR', name: 'فرانسه', flag: '🇫🇷' },
                { code: 'JP', name: 'ژاپن', flag: '🇯🇵' },
                { code: 'SG', name: 'سنگاپور', flag: '🇸🇬' },
                { code: 'TR', name: 'ترکیه', flag: '🇹🇷' },
                { code: 'IR', name: 'ایران', flag: '🇮🇷' }
            ];

            topCountries.forEach(country => {
                const col = document.createElement('div');
                col.className = 'col-lg-2 col-md-3 col-sm-4 col-6 mb-3';
                col.innerHTML = `
                    <div class="text-center">
                        <div class="country-flag">${country.flag}</div>
                        <div class="h6">${country.name}</div>
                        <a href="by_country/${country.code}.txt" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
                            دانلود
                        </a>
                    </div>
                `;
                countryContainer.appendChild(col);
            });
        }

        // Update system status
        function updateSystemStatus(report) {
            const statusContainer = document.getElementById('systemStatus');
            const lastCheck = new Date(report.timestamp || Date.now());

            statusContainer.innerHTML = `
                <div class="col-md-4">
                    <div class="alert alert-success alert-custom">
                        <i class="fas fa-check-circle"></i>
                        <strong>GitHub Actions:</strong> فعال
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info alert-custom">
                        <i class="fas fa-clock"></i>
                        <strong>آخرین بررسی:</strong> ${lastCheck.toLocaleString('fa-IR')}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-warning alert-custom">
                        <i class="fas fa-sync-alt"></i>
                        <strong>فاصله بروزرسانی:</strong> هر 30 دقیقه
                    </div>
                </div>
            `;
        }

        // Update last update time
        function updateLastUpdate(report) {
            const lastUpdate = new Date(report.timestamp || Date.now());
            document.getElementById('lastUpdate').innerHTML =
                `<i class="fas fa-clock"></i> آخرین بروزرسانی: ${lastUpdate.toLocaleString('fa-IR')}`;
        }

        // Show error message
        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadDashboardData);

        // Auto-refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>

</html>