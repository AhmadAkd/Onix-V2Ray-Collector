<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست صفحات</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🧪 تست عملکرد صفحات</h1>

    <div class="section">
        <h2>📊 تست بارگذاری latest_report.json</h2>
        <button onclick="testReportLoading()">🔄 تست بارگذاری</button>
        <div id="reportTest"></div>
    </div>

    <div class="section">
        <h2>📋 تست index.html</h2>
        <button onclick="testIndex()">🔄 تست Index</button>
        <div id="indexTest"></div>
    </div>

    <div class="section">
        <h2>📊 تست dashboard.html</h2>
        <button onclick="testDashboard()">🔄 تست Dashboard</button>
        <div id="dashboardTest"></div>
    </div>

    <div class="section">
        <h2>🔄 تست Auto-Refresh</h2>
        <p>Auto-refresh فعال است و هر 5 دقیقه اجرا می‌شود</p>
        <p>آخرین بارگذاری: <span id="lastLoad">-</span></p>
        <p>تعداد بارگذاری: <span id="loadCount">0</span></p>
    </div>

    <script>
        let loadCounter = 0;

        async function testReportLoading() {
            const output = document.getElementById('reportTest');
            output.innerHTML = '<p>در حال بارگذاری...</p>';
            
            try {
                const response = await fetch('subscriptions/latest_report.json');
                const report = await response.json();
                
                output.innerHTML = `
                    <p class="success">✅ بارگذاری موفق!</p>
                    <pre>${JSON.stringify(report, null, 2)}</pre>
                    <h3>بررسی ساختار:</h3>
                    <p>✅ timestamp: ${report.timestamp || '❌ ندارد'}</p>
                    <p>✅ working_configs: ${report.working_configs || '❌ ندارد'}</p>
                    <p>✅ protocols: ${Object.keys(report.protocols || {}).length} پروتکل</p>
                `;
            } catch (error) {
                output.innerHTML = `<p class="error">❌ خطا: ${error.message}</p>`;
            }
        }

        async function testIndex() {
            const output = document.getElementById('indexTest');
            output.innerHTML = '<p>در حال تست...</p>';
            
            try {
                const response = await fetch('subscriptions/latest_report.json');
                const report = await response.json();
                
                // شبیه‌سازی کد index.html
                const totalConfigs = report.working_configs || 0;
                const lastUpdate = report.timestamp || 'نامشخص';
                
                let protocolsHTML = '<h4>پروتکل‌ها:</h4>';
                if (report.protocols) {
                    Object.entries(report.protocols).forEach(([protocol, data]) => {
                        protocolsHTML += `<p>- ${protocol}: ${data.count} (${data.avg_latency})</p>`;
                    });
                }
                
                output.innerHTML = `
                    <p class="success">✅ تست موفق!</p>
                    <h4>داده‌های پردازش شده:</h4>
                    <p>📊 کل کانفیگ‌ها: ${totalConfigs.toLocaleString('fa-IR')}</p>
                    <p>🕐 آخرین بروزرسانی: ${lastUpdate}</p>
                    ${protocolsHTML}
                `;
            } catch (error) {
                output.innerHTML = `<p class="error">❌ خطا: ${error.message}</p>`;
            }
        }

        async function testDashboard() {
            const output = document.getElementById('dashboardTest');
            output.innerHTML = '<p>در حال تست...</p>';
            
            try {
                const response = await fetch('subscriptions/latest_report.json');
                const report = await response.json();
                
                // شبیه‌سازی کد dashboard.html
                const totalHealthy = report.working_configs || 0;
                const totalFailed = report.failed_configs || 0;
                
                let successRate = 0;
                if (typeof report.success_rate === 'string') {
                    successRate = parseFloat(report.success_rate.replace('%', ''));
                }
                
                output.innerHTML = `
                    <p class="success">✅ تست موفق!</p>
                    <h4>آمار:</h4>
                    <p>✅ سالم: ${totalHealthy.toLocaleString('fa-IR')}</p>
                    <p>❌ ناسالم: ${totalFailed.toLocaleString('fa-IR')}</p>
                    <p>📊 نرخ موفقیت: ${successRate}%</p>
                    <p>🔌 پروتکل‌ها: ${Object.keys(report.protocols || {}).length}</p>
                `;
            } catch (error) {
                output.innerHTML = `<p class="error">❌ خطا: ${error.message}</p>`;
            }
        }

        // Auto-refresh simulation
        function simulateAutoRefresh() {
            loadCounter++;
            document.getElementById('loadCount').textContent = loadCounter;
            document.getElementById('lastLoad').textContent = new Date().toLocaleString('fa-IR');
        }

        // Simulate auto-refresh every 10 seconds (for demo)
        setInterval(simulateAutoRefresh, 10000);
        simulateAutoRefresh();
    </script>
</body>
</html>

